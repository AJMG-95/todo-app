<!-- src/app/features/todo/pages/todo-page.component.html -->

<div class="flex flex-col justify-center gap-12 w-full">
  <!-- Filtros -->
  <p-card>
    <app-task-filters
      [filters]="filters"
      [statusOptions]="statusOptions"
      (filtersChanged)="applyFilters()"
    />
  </p-card>

  <div class="flex justify-end w-full gap-2">
    <p-button
      label="Crear Tarea"
      icon="pi pi-plus"
      [raised]="true"
      (onClick)="showCreateModal = true"
    ></p-button>

    <p-button
      label="Eliminar Todas"
      severity="danger"
      icon="pi pi-trash"
      [raised]="true"
      (onClick)="confirmDeleteAll()"
    ></p-button>
  </div>

  <!-- Tabla de Tareas -->
  <p-card>
    <section class="p-4">
      <h2 class="text-xl font-semibold mb-4">Lista de Tareas</h2>

      <p-table
        [value]="filteredTasks"
        [paginator]="true"
        [rows]="5"
        [rowsPerPageOptions]="[5, 10, 20]"
        class="p-12"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>
              Título <i class="pi pi-pencil ml-1 text-xs text-gray-400"></i>
            </th>
            <th>
              Descripción
              <i class="pi pi-pencil ml-1 text-xs text-gray-400"></i>
            </th>
            <th>
              Categoría <i class="pi pi-pencil ml-1 text-xs text-gray-400"></i>
            </th>
            <th>
              Estado <i class="pi pi-pencil ml-1 text-xs text-gray-400"></i>
            </th>
            <th>Fecha de Creación</th>
            <th>
              Fecha de Inicio
              <i class="pi pi-pencil ml-1 text-xs text-gray-400"></i>
            </th>
            <th>
              Fecha Fin Estimada
              <i class="pi pi-pencil ml-1 text-xs text-gray-400"></i>
            </th>
            <th>Fecha Finalización</th>
            <th>Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-task>
          <tr [class.opacity-60]="isCompleted(task)">
            <!-- Título -->
            <td
              (click)="
                !isCompleted(task) &&
                  !isEditing(task.id, 'title') &&
                  startEditing(task.id, 'title')
              "
              [class]="!isCompleted(task) ? 'cursor-pointer' : ''"
            >
              <ng-container
                *ngIf="isEditing(task.id, 'title'); else titleDisplay"
              >
                <input
                  pInputText
                  [(ngModel)]="task.title"
                  class="w-full"
                  (click)="$event.stopPropagation()"
                />
                <div class="flex gap-1 mt-1">
                  <button
                    pButton
                    icon="pi pi-check"
                    class="p-button-sm p-button-success"
                    (click)="saveEdit(task, 'title'); $event.stopPropagation()"
                  ></button>
                  <button
                    pButton
                    icon="pi pi-times"
                    class="p-button-sm p-button-danger"
                    (click)="
                      cancelEdit(task.id, 'title'); $event.stopPropagation()
                    "
                  ></button>
                </div>
              </ng-container>
              <ng-template #titleDisplay
                ><span>{{ task.title }}</span></ng-template
              >
            </td>

            <!-- Descripción -->
            <td
              (click)="
                !isCompleted(task) &&
                  !isEditing(task.id, 'description') &&
                  startEditing(task.id, 'description')
              "
              [class]="!isCompleted(task) ? 'cursor-pointer' : ''"
            >
              <ng-container
                *ngIf="isEditing(task.id, 'description'); else descDisplay"
              >
                <input
                  pInputText
                  [(ngModel)]="task.description"
                  class="w-full"
                  (click)="$event.stopPropagation()"
                />
                <div class="flex gap-1 mt-1">
                  <button
                    pButton
                    icon="pi pi-check"
                    class="p-button-sm p-button-success"
                    (click)="
                      saveEdit(task, 'description'); $event.stopPropagation()
                    "
                  ></button>
                  <button
                    pButton
                    icon="pi pi-times"
                    class="p-button-sm p-button-danger"
                    (click)="
                      cancelEdit(task.id, 'description');
                      $event.stopPropagation()
                    "
                  ></button>
                </div>
              </ng-container>
              <ng-template #descDisplay
                ><span>{{ task.description }}</span></ng-template
              >
            </td>

            <!-- Categoría -->
            <td
              (click)="
                !isCompleted(task) &&
                  !isEditing(task.id, 'category') &&
                  startEditing(task.id, 'category')
              "
              [class]="!isCompleted(task) ? 'cursor-pointer' : ''"
            >
              <ng-container
                *ngIf="isEditing(task.id, 'category'); else categoryDisplay"
              >
                <input
                  pInputText
                  [(ngModel)]="task.category"
                  class="w-full"
                  (click)="$event.stopPropagation()"
                />
                <div class="flex gap-1 mt-1">
                  <button
                    pButton
                    icon="pi pi-check"
                    class="p-button-sm p-button-success"
                    (click)="
                      saveEdit(task, 'category'); $event.stopPropagation()
                    "
                  ></button>
                  <button
                    pButton
                    icon="pi pi-times"
                    class="p-button-sm p-button-danger"
                    (click)="
                      cancelEdit(task.id, 'category'); $event.stopPropagation()
                    "
                  ></button>
                </div>
              </ng-container>
              <ng-template #categoryDisplay
                ><span>{{ task.category }}</span></ng-template
              >
            </td>

            <!-- Estado -->
            <td [class]="!isCompleted(task) ? 'cursor-pointer' : ''">
              <p-dropdown
                [options]="editableStatusOptions"
                [(ngModel)]="task.statusId"
                optionLabel="label"
                optionValue="value"
                [ngClass]="{
                  'bg-gray-200': task.statusId === 1,
                  'bg-yellow-100': task.statusId === 2,
                  'bg-green-100': task.statusId === 3,
                  'bg-red-100': task.statusId === 4
                }"
                class="w-full"
                (onChange)="onStatusChange(task)"
                [appendTo]="'body'"
                panelStyleClass="status-dropdown-panel"
                [autoZIndex]="true"
                [baseZIndex]="2000"
                [disabled]="isCompleted(task)"
              ></p-dropdown>
            </td>

            <!-- Fechas -->
            <td>
              <i class="pi pi-calendar mr-1 text-gray-400"></i>
              {{ task.createdAt }}
            </td>

            <!-- startDate (input nativo) -->
            <td
              (click)="
                !isCompleted(task) &&
                  !isEditing(task.id, 'startDate') &&
                  startEditing(task.id, 'startDate')
              "
              [class]="!isCompleted(task) ? 'cursor-pointer' : ''"
            >
              <ng-container
                *ngIf="isEditing(task.id, 'startDate'); else startDisplay"
              >
                <input
                  type="date"
                  class="w-full p-inputtext p-component"
                  [ngModel]="
                    (dateEditBufferStr[task.id] &&
                      dateEditBufferStr[task.id].startDate) ||
                    ''
                  "
                  (ngModelChange)="
                    onDateBufferStrChange(task.id, 'startDate', $event)
                  "
                  (click)="$event.stopPropagation()"
                />
                <div class="flex gap-1 mt-1">
                  <button
                    pButton
                    icon="pi pi-check"
                    class="p-button-sm p-button-success"
                    (click)="
                      saveEdit(task, 'startDate'); $event.stopPropagation()
                    "
                  ></button>
                  <button
                    pButton
                    icon="pi pi-times"
                    class="p-button-sm p-button-danger"
                    (click)="
                      cancelEdit(task.id, 'startDate'); $event.stopPropagation()
                    "
                  ></button>
                </div>
              </ng-container>
              <ng-template #startDisplay>
                <i class="pi pi-calendar mr-1 text-gray-400"></i>
                <span>{{ task.startDate }}</span>
              </ng-template>
            </td>

            <!-- estimatedEndDate (input nativo) -->
            <td
              (click)="
                !isCompleted(task) &&
                  !isEditing(task.id, 'estimatedEndDate') &&
                  startEditing(task.id, 'estimatedEndDate')
              "
              [class]="!isCompleted(task) ? 'cursor-pointer' : ''"
            >
              <ng-container
                *ngIf="
                  isEditing(task.id, 'estimatedEndDate');
                  else estimatedDisplay
                "
              >
                <input
                  type="date"
                  class="w-full p-inputtext p-component"
                  [ngModel]="
                    (dateEditBufferStr[task.id] &&
                      dateEditBufferStr[task.id].estimatedEndDate) ||
                    ''
                  "
                  (ngModelChange)="
                    onDateBufferStrChange(task.id, 'estimatedEndDate', $event)
                  "
                  (click)="$event.stopPropagation()"
                />
                <div class="flex gap-1 mt-1">
                  <button
                    pButton
                    icon="pi pi-check"
                    class="p-button-sm p-button-success"
                    (click)="
                      saveEdit(task, 'estimatedEndDate');
                      $event.stopPropagation()
                    "
                  ></button>
                  <button
                    pButton
                    icon="pi pi-times"
                    class="p-button-sm p-button-danger"
                    (click)="
                      cancelEdit(task.id, 'estimatedEndDate');
                      $event.stopPropagation()
                    "
                  ></button>
                </div>
              </ng-container>
              <ng-template #estimatedDisplay>
                <i class="pi pi-calendar mr-1 text-gray-400"></i>
                <span>{{ task.estimatedEndDate }}</span>
              </ng-template>
            </td>

            <!-- Fecha Finalización (solo lectura) -->
            <td>
              <i class="pi pi-calendar mr-1 text-gray-400"></i>
              <span>{{ task.realEndDate || "—" }}</span>
            </td>

            <!-- Acciones -->
            <td>
              <button
                pButton
                icon="pi pi-eye"
                class="p-button-sm p-button-text"
                (click)="watchTask(task)"
              ></button>
              <button
                pButton
                icon="pi pi-pencil"
                class="p-button-sm p-button-text text-blue-500"
                (click)="editTask(task)"
                [disabled]="isCompleted(task)"
              ></button>
              <button
                pButton
                icon="pi pi-trash"
                class="p-button-sm p-button-text text-red-500"
                (click)="deleteTask(task.id)"
              ></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </section>
  </p-card>

  <!-- Modal Crear -->
  <task-create-modal
    [(visible)]="showCreateModal"
    [taskToEdit]="selectedTask"
    (visibleChange)="onCreateModalClosed()"
    (taskCreated)="onTaskCreated()"
    (taskUpdated)="onTaskUpdated()"
  />

  <!-- Modal Detalle -->
  <task-detail-modal
    [(visible)]="showDetailModal"
    [task]="selectedTask!"
    (visibleChange)="onDetailModalClosed()"
  />
</div>
