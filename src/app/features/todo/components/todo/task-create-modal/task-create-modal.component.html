<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [closable]="true"
  (onHide)="handleClose()"
  [style]="{ width: '90vw', maxWidth: '700px' }"
  [header]="taskToEdit ? 'Editar Tarea ✏️' : 'Crear Nueva Tarea'"
>
  <div class="flex flex-col justify-between h-full">
    <!-- FORMULARIO PRINCIPAL -->
    <form
      [formGroup]="taskForm"
      (ngSubmit)="onSubmit()"
      class="flex flex-col gap-4 overflow-y-auto pr-1 max-h-[75vh] p-4"
    >
      <section>
        <p-floatlabel variant="on">
          <input
            pInputText
            formControlName="title"
            id="title"
            class="w-full"
            [ngClass]="{
              'border border-red-500':
                formSubmitted && taskForm.controls['title'].invalid
            }"
          />
          <label for="title">Título</label>
        </p-floatlabel>
        <small
          *ngIf="formSubmitted && taskForm.controls['title'].invalid"
          class="text-red-500"
        >
          El título es obligatorio.
        </small>
      </section>

      <section>
        <p-floatlabel variant="on">
          <input
            pInputText
            formControlName="description"
            class="w-full"
            id="description"
          />
          <label for="description">Descripción</label>
        </p-floatlabel>
        <small
          *ngIf="formSubmitted && taskForm.controls['description'].invalid"
          class="text-red-500"
        >
          La descripción es obligatoria.
        </small>
      </section>

      <section>
        <p-floatlabel variant="on">
          <input
            pInputText
            formControlName="category"
            id="category"
            class="w-full"
          />
          <label for="category">Categoría</label>
        </p-floatlabel>
      </section>

      <section>
        <p-floatlabel variant="on">
          <input pInputText formControlName="tags" id="tags" class="w-full" />
          <label for="tags">Etiquetas (coma separadas)</label>
        </p-floatlabel>
      </section>

      <!-- Fechas (inputs nativos) -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
        <section>
          <label for="startDate" class="block mb-1 text-sm text-gray-600"
            >Fecha de inicio</label
          >
          <input
            type="date"
            id="startDate"
            class="w-full p-inputtext p-component"
            formControlName="startDate"
          />
        </section>

        <section>
          <label for="estimatedEndDate" class="block mb-1 text-sm text-gray-600"
            >Fecha fin estimada</label
          >
          <input
            type="date"
            id="estimatedEndDate"
            class="w-full p-inputtext p-component"
            formControlName="estimatedEndDate"
            required
          />

          <small
            *ngIf="formSubmitted && taskForm.controls['estimatedEndDate'].errors?.['required']"
            class="text-red-500"
          >
            La fecha fin estimada es obligatoria.
          </small>

          <small
            *ngIf="(formSubmitted || taskForm.controls['estimatedEndDate'].touched) && taskForm.controls['estimatedEndDate'].errors?.['dateOrder']"
            class="text-red-500"
          >
            La fecha fin estimada no puede ser anterior a la fecha de inicio.
          </small>
        </section>
      </div>

      <!-- Subtareas -->
      <div *ngIf="taskToEdit" class="mt-4">
        <h3 class="text-md font-semibold mb-2">Subtareas</h3>

        <div class="flex flex-col sm:flex-row gap-2 mb-2">
          <section class="w-full">
            <p-floatlabel variant="on">
              <input
                pInputText
                [(ngModel)]="newSubtaskText"
                [ngModelOptions]="{ standalone: true }"
                name="newSubtaskText"
                id="newSubtaskText"
                class="flex-1 w-full"
              />
              <label for="newSubtaskText">Nueva subtarea</label>
            </p-floatlabel>
          </section>

          <button
            *ngIf="deletedSubtasksBackup.length !== 0"
            type="button"
            pButton
            icon="pi pi-undo"
            class="p-button-sm p-button-secondary"
            (click)="undoLastSubtaskRemoval()"
          ></button>

          <button
            type="button"
            pButton
            icon="pi pi-plus"
            class="p-button-sm min-w-[128px]"
            label="Añadir"
            (click)="addSubtask(newSubtaskText)"
            [disabled]="!newSubtaskText.trim()"
          ></button>
        </div>

        <div
          class="h-40 overflow-y-auto border border-gray-300 rounded p-2 bg-blue-50 shadow-inner"
        >
          <ul class="list-disc pl-4 pr-2">
            <li
              *ngFor="let subtask of subtasks"
              class="mb-2 flex items-center gap-2"
            >
              <input
                pInputText
                [(ngModel)]="subtask.text"
                [ngModelOptions]="{ standalone: true }"
                class="w-full"
                name="subtask-{{ subtask.id }}"
              />
              <button
                type="button"
                pButton
                icon="pi pi-trash"
                class="p-button-text p-button-sm text-red-500"
                (click)="removeSubtask(subtask.id)"
              ></button>
            </li>
          </ul>
        </div>
      </div>

      <!-- Botones (dentro del form) -->
      <div class="flex justify-end gap-2 pt-4 border-t mt-4">
        <button
          type="button"
          pButton
          label="Cancelar"
          class="p-button-secondary"
          (click)="handleClose()"
        ></button>
        <button
          type="submit"
          pButton
          [label]="taskToEdit ? 'Actualizar' : 'Crear'"
        ></button>
      </div>
    </form>
  </div>
</p-dialog>
