<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [closable]="true"
  (onHide)="close()"
  [style]="{ width: '90vw', maxWidth: '700px' }"
  [header]="taskToEdit ? 'Editar Tarea' : 'Crear Nueva Tarea'"
>
  <form
    [formGroup]="taskForm"
    (ngSubmit)="onSubmit()"
    class="flex flex-col gap-4"
  >
    <div class="w-full">
      <input
        pInputText
        type="text"
        placeholder="Título"
        formControlName="title"
        class="w-full"
      />
      <small
        *ngIf="formSubmitted && taskForm.controls['title'].invalid"
        class="text-red-500"
      >
        El título es obligatorio.
      </small>
    </div>

    <div class="w-full">
      <input
        pInputText
        type="text"
        placeholder="Descripción"
        formControlName="description"
        class="w-full"
      />
      <small
        *ngIf="formSubmitted && taskForm.controls['description'].invalid"
        class="text-red-500"
      >
        La descripción es obligatoria.
      </small>
    </div>

    <input
      pInputText
      type="text"
      placeholder="Categoría"
      formControlName="category"
    />
    <input
      pInputText
      type="text"
      placeholder="Etiquetas (separadas por comas)"
      formControlName="tags"
    />
    <div class="flex flex-col md:flex-row w-full gap-4 md:gap-8">
      <!-- Fecha estimada -->
      <div class="w-full flex flex-col justify-center">
        <p-calendar
          formControlName="estimatedEndDate"
          [showIcon]="true"
          dateFormat="yy-mm-dd"
          placeholder="Fecha estimada de finalización"
          appendTo="body"
        ></p-calendar>
        <small
          *ngIf="formSubmitted && taskForm.controls['estimatedEndDate'].invalid"
          class="text-red-500 mt-1"
        >
          Este campo es obligatorio.
        </small>
      </div>

      <!-- Fecha real -->
      <p-calendar
        formControlName="realEndDate"
        [showIcon]="true"
        dateFormat="yy-mm-dd"
        placeholder="Fecha real de finalización (opcional)"
        class="w-full px-0 mx-0"
        appendTo="body"
      ></p-calendar>
    </div>

    <div class="flex justify-end gap-2 pt-4">
      <button
        pButton
        type="button"
        label="Cancelar"
        class="p-button-secondary"
        (click)="close()"
      ></button>
      <button
        pButton
        type="submit"
        [label]="taskToEdit ? 'Actualizar' : 'Crear'"
      ></button>
    </div>
  </form>

  <!-- Subtareas (solo visible después de crear o al editar) -->
  <div
    *ngIf="taskForm.valid && (taskToEdit || showSubtaskSection)"
    class="mt-6"
  >
    <h3 class="text-lg font-semibold mb-2">Subtareas</h3>

    <div class="flex flex-col sm:flex-row gap-2 mb-2">
      <input
        pInputText
        type="text"
        placeholder="Nueva subtarea"
        [(ngModel)]="newSubtaskText"
        name="newSubtaskText"
      />
      <button
        pButton
        icon="pi pi-plus"
        label="Añadir"
        class="p-button-sm"
        (click)="addSubtask(newSubtaskText)"
        [disabled]="!newSubtaskText?.trim()"
      ></button>
    </div>

    <ul class="pl-4 list-disc">
      <li *ngFor="let subtask of subtasks">
        <input
          pInputText
          type="text"
          [(ngModel)]="subtask.text"
          class="mr-2"
          name="subtask-{{ subtask.id }}"
        />
        <button
          pButton
          icon="pi pi-trash"
          class="p-button-text p-button-sm text-red-500"
          (click)="removeSubtask(subtask.id)"
        ></button>
      </li>
    </ul>
  </div>
</p-dialog>
